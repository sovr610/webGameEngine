<html>
<head>
	<title>Lua Demo</title>
	<script type="text/javascript" src="/lua.vm.js"></script>
	<script type="text/lua">
local jid, password = "visitors.chatid.com";
local url = "/xmpp-websocket";
package.preload['util.encodings']=function()
	local stringprep = { }
	function stringprep.nodeprep (node)
		return node
	end
	function stringprep.nameprep (name)
		return name
	end
	function stringprep.resourceprep (resource)
		return resource
	end
	return {
		stringprep = stringprep ;
	}
end
package.preload['mime']=function()
	return {
		b64 = function(s) return window:btoa(s) end;
	}
end

local verse = require "verse".init("client", "websocket");
c = verse.new_websocket(nil, url);

c:add_plugin("version");

-- Add some hooks for debugging
c:hook("opened", function () print("Stream opened!") end);
c:hook("closed", function () print("Stream closed!") end);
c:hook("stanza", function (stanza) print("Stanza:", stanza) end);

-- This one prints all received data
c:hook("incoming-raw", print, 1000);

-- Print a message after authentication
c:hook("authentication-success", function () print("Logged in!"); end);
c:hook("authentication-failure", function (err) print("Failed to log in! Error: "..tostring(err.condition)); end);

-- Print a message and exit when disconnected
c:hook("disconnected", function () print("Disconnected!"); os.exit(); end);

-- Now, actually start the connection:
c:connect_client(jid, password);

-- Catch the "ready" event to know when the stream is ready to use
c:hook("ready", function ()
	print("Stream ready!");
	c.version:set{ name = "Verse example BOSH client" };
	c:query_version(c.jid, function (v) print("I am using "..(v.name or "<unknown>")); end);
end);

	</script>
</head>
<body>
</body>
</html>
